<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Compress images online without losing quality.">
    <meta name="keywords" content="image compressor, compress images, online tool">
    <meta name="author" content="Kanhaiya Mishra">
    <title>Image Compressor - Image & PDF Tools</title>

    <!-- Google Fonts - Poppins for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Theme Variables - Modernized Colors */
        :root {
            --bg-color: #f0f2f5; /* Light grey background */
            --text-color: #2d3748; /* Dark text */
            --header-bg-start: #6b73ff; /* Vibrant Gradient Start */
            --header-bg-end: #00d9f5;   /* Vibrant Gradient End */
            --nav-bg: #ffffff; /* White nav */
            --nav-text-color: #4a5568; /* Darker nav text */
            --card-bg: #ffffff; /* White card */
            --shadow-color: rgba(0, 0, 0, 0.1);
            --accent-color: #6b73ff; /* Primary accent color */
            --accent-dark: #5a63e6; /* Darker accent for hover */
            --border-color: #e2e8f0; /* Light border */
            --success-color: #48bb78; /* Green success */
            --error-color: #f56565; /* Red error */
            --warning-color: #ed8936; /* Orange warning */
        }

        [data-theme="dark"] {
            --bg-color: #1a202c; /* Dark background */
            --text-color: #e2e8f0; /* Light text */
            --header-bg-start: #1e3a8a; /* Darker Gradient Start */
            --header-bg-end: #0d415d;   /* Darker Gradient End */
            --nav-bg: #2d3748; /* Dark nav */
            --nav-text-color: #e2e8f0; /* Light nav text */
            --card-bg: #2d3748; /* Dark card */
            --shadow-color: rgba(255, 255, 255, 0.08);
            --accent-color: #4299e1; /* Blue accent for dark mode */
            --accent-dark: #3182ce; /* Darker blue */
            --border-color: #4a5568; /* Dark border */
            --success-color: #68d391; /* Lighter green */
            --error-color: #fc8181; /* Lighter red */
            --warning-color: #f6ad55; /* Lighter orange */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh; /* Ensure body takes at least full viewport height */
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--header-bg-start), var(--header-bg-end));
            color: white;
            padding: 60px 20px 40px; /* More padding */
            text-align: center;
            box-shadow: 0 4px 10px var(--shadow-color);
            position: relative; /* Needed for theme switcher absolute pos */
            overflow: hidden; /* Hide overflow from gradient */
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.1"><circle cx="20" cy="20" r="15" fill="white"/><circle cx="80" cy="80" r="10" fill="white"/><rect x="50" y="10" width="10" height="10" fill="white"/><rect x="10" y="60" width="15" height="15" fill="white"/></svg>') repeat;
            background-size: 80px; /* Subtle pattern */
            pointer-events: none;
            mix-blend-mode: overlay; /* Or screen/soft-light */
        }


        header span {
            font-size: 4.5rem; /* Larger icon */
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(2px 2px 5px rgba(0,0,0,0.2)); /* Add shadow to icon */
        }
        header h1 {
            font-size: 3rem; /* Larger heading */
            font-weight: 700; /* Bolder */
            margin-bottom: 15px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        header p {
            font-size: 1.3rem; /* Larger paragraph */
            opacity: 0.95;
            max-width: 700px;
            margin: 0 auto; /* Center description */
        }
        /* Theme Switcher Button */
        #theme-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px; /* Slightly smaller padding */
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent white */
            color: var(--text-color); /* Use text color from theme */
            border: none;
            border-radius: 20px; /* More rounded */
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px); /* Frosted glass effect */
            z-index: 10; /* Ensure it's above header pattern */
        }
         [data-theme="dark"] #theme-switcher {
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
             color: var(--nav-text-color); /* Use light text color */
        }
        #theme-switcher:hover {
            background-color: rgba(255, 255, 255, 1);
             box-shadow: 0 2px 5px var(--shadow-color);
             transform: translateY(-1px);
        }
         [data-theme="dark"] #theme-switcher:hover {
             background-color: rgba(0, 0, 0, 0.7);
         }


        /* Navigation */
        nav {
            background-color: var(--nav-bg);
            padding: 15px 20px; /* More vertical padding */
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        nav a {
            color: var(--nav-text-color);
            text-decoration: none;
            margin: 0 20px; /* More margin between links */
            font-size: 1.1rem;
            font-weight: 500;
            transition: color 0.3s ease, transform 0.2s ease;
            position: relative; /* For underline effect */
        }
        nav a::after {
             content: '';
             position: absolute;
             width: 0;
             height: 3px;
             bottom: -8px; /* Position below text */
             left: 50%; /* Start from center */
             transform: translateX(-50%);
             background-color: var(--accent-color);
             transition: width 0.3s ease-out;
        }
        nav a:hover::after, nav a:focus::after {
             width: 100%; /* Expand underline on hover/focus */
        }
        nav a:hover, nav a:focus {
            color: var(--accent-color);
            transform: translateY(-2px); /* Slight lift on hover */
        }

        /* Main Content */
        main {
            padding: 30px 20px; /* More padding */
            max-width: 900px; /* Slightly narrower main content */
            margin: 20px auto; /* Add margin top/bottom and center */
            flex-grow: 1; /* Allow main content to take available space */
        }

        /* Compressor Tool Card */
        #compressor-tool {
            background: var(--card-bg);
            padding: 30px; /* More padding */
            border-radius: 20px; /* More rounded corners */
            box-shadow: 0 10px 20px var(--shadow-color);
            margin-bottom: 30px;
            border: 1px solid var(--border-color); /* Subtle border */
            transition: transform 0.3s ease; /* Add transition */
        }
        #compressor-tool:hover {
             transform: translateY(-5px); /* Lift card on hover */
        }

        #compressor-tool h2 {
            font-size: 2rem; /* Larger heading */
            margin-bottom: 25px;
            color: var(--accent-color); /* Use accent color */
            text-align: center; /* Center heading */
            font-weight: 600;
        }

        #compressor-tool form {
            display: flex;
            flex-direction: column;
            gap: 20px; /* Increased gap */
        }

        #compressor-tool label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        /* Custom File Input Styling */
        .file-upload-area {
            border: 2px dashed var(--border-color); /* Dashed border */
            border-radius: 10px; /* Rounded corners */
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: rgba(var(--accent-color-rgb, 107, 115, 255), 0.05); /* Subtle background */
            color: var(--text-color);
        }
        .file-upload-area:hover {
            border-color: var(--accent-color); /* Accent color on hover */
            background-color: rgba(var(--accent-color-rgb, 107, 115, 255), 0.1);
        }
         [data-theme="dark"] .file-upload-area {
             background-color: rgba(var(--accent-color-rgb, 66, 153, 225), 0.1);
         }
         [data-theme="dark"] .file-upload-area:hover {
             background-color: rgba(var(--accent-color-rgb, 66, 153, 225), 0.2);
         }

        .file-upload-area input[type="file"] {
            display: none; /* Hide the default input */
        }

        .upload-icon {
            font-size: 3rem; /* Large icon */
            color: var(--accent-color);
            margin-bottom: 10px;
            display: block;
        }
         [data-theme="dark"] .upload-icon {
            color: var(--accent-color);
        }


        .upload-text strong {
            color: var(--accent-color);
        }

        /* Text Input Styling */
        #compressor-tool input[type="text"] {
            padding: 12px 20px; /* More padding */
            border: 1px solid var(--border-color); /* Solid border */
            border-radius: 10px; /* Rounded corners */
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: var(--card-bg);
            color: var(--text-color);
            width: 100%; /* Full width */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
         [data-theme="dark"] #compressor-tool input[type="text"] {
            border-color: var(--border-color);
            background-color: var(--card-bg);
        }
        #compressor-tool input[type="text"]:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb, 107, 115, 255), 0.3); /* Focus ring */
            outline: none;
        }
         [data-theme="dark"] #compressor-tool input[type="text"]:focus {
             box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb, 66, 153, 225), 0.3);
         }


        /* Button Styling */
        #compressor-tool button {
            padding: 12px 25px; /* More padding */
            background: linear-gradient(45deg, var(--accent-color), var(--accent-dark)); /* Gradient button */
            color: white;
            border: none;
            border-radius: 10px; /* Rounded corners */
            font-size: 1.1rem; /* Larger font */
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(var(--accent-color-rgb, 107, 115, 255), 0.3);
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
         [data-theme="dark"] #compressor-tool button {
             background: linear-gradient(45deg, var(--accent-color), var(--accent-dark));
             box-shadow: 0 5px 15px rgba(var(--accent-color-rgb, 66, 153, 225), 0.3);
         }

        #compressor-tool button:hover {
            background: linear-gradient(45deg, var(--accent-dark), var(--accent-color)); /* Reverse gradient on hover */
            box-shadow: 0 8px 20px rgba(var(--accent-color-rgb, 107, 115, 255), 0.4);
            transform: translateY(-3px); /* More pronounced lift */
        }
         [data-theme="dark"] #compressor-tool button:hover {
             background: linear-gradient(45deg, var(--accent-dark), var(--accent-color));
             box-shadow: 0 8px 20px rgba(var(--accent-color-rgb, 66, 153, 225), 0.4);
         }
        #compressor-tool button:active {
             transform: translateY(0); /* Press effect */
             box-shadow: 0 3px 10px rgba(var(--accent-color-rgb, 107, 115, 255), 0.3);
        }
        #compressor-tool button:disabled {
            background: #cccccc;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
            opacity: 0.7;
        }
         [data-theme="dark"] #compressor-tool button:disabled {
             background: #555;
         }


        #compressor-tool #output {
            margin-top: 30px; /* More space */
            text-align: center;
            display: none;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color); /* Separator */
        }

        #compressor-tool #output h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--text-color);
            font-weight: 600;
        }

        #compressor-tool #compressed-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px; /* Rounded corners */
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 20px; /* Space below image */
            border: 1px solid var(--border-color); /* Subtle border */
        }

        #compressor-tool #download-link {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--success-color); /* Green download button */
            color: white;
            text-decoration: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3); /* Green shadow */
            transition: all 0.3s ease;
            font-weight: 600;
        }
         [data-theme="dark"] #compressor-tool #download-link {
             background-color: var(--success-color);
         }

        #compressor-tool #download-link:hover {
            background-color: var(--success-color); /* Keep same color or slightly darker */
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
            transform: translateY(-3px);
        }
         [data-theme="dark"] #compressor-tool #download-link:hover {
              background-color: var(--success-color);
         }
        #compressor-tool #download-link:active {
             transform: translateY(0);
             box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
        }


        #compressor-tool #user-feedback {
            margin-top: 20px;
            font-size: 0.9rem;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        #user-feedback.success {
             color: var(--success-color);
             background-color: rgba(var(--success-color-rgb, 72, 187, 120), 0.1);
             border: 1px solid var(--success-color);
        }
         #user-feedback.error {
             color: var(--error-color);
             background-color: rgba(var(--error-color-rgb, 245, 101, 101), 0.1);
             border: 1px solid var(--error-color);
         }
         #user-feedback.warning {
             color: var(--warning-color);
             background-color: rgba(var(--warning-color-rgb, 237, 137, 54), 0.1);
             border: 1px solid var(--warning-color);
         }
         #user-feedback.loading {
             color: var(--text-color);
             background-color: var(--border-color);
             border: none;
         }
         [data-theme="dark"] #user-feedback.success {
             background-color: rgba(var(--success-color-rgb, 104, 211, 145), 0.15);
         }
          [data-theme="dark"] #user-feedback.error {
             background-color: rgba(var(--error-color-rgb, 252, 129, 129), 0.15);
          }
          [data-theme="dark"] #user-feedback.warning {
             background-color: rgba(var(--warning-color-rgb, 246, 173, 85), 0.15);
          }
          [data-theme="dark"] #user-feedback.loading {
             background-color: var(--border-color);
          }


        /* Footer */
        footer {
            background-color: var(--nav-bg); /* Use nav background */
            color: var(--nav-text-color); /* Use nav text color */
            text-align: center;
            padding: 20px 0;
            margin-top: auto; /* Push footer to bottom */
            box-shadow: 0 -2px 4px var(--shadow-color);
        }
        footer p {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 400;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                 padding: 40px 20px 30px;
            }
            header h1 {
                font-size: 2.5rem;
            }
            header p {
                font-size: 1.1rem;
            }
            nav {
                padding: 10px 10px;
            }
            nav a {
                margin: 0 10px;
                font-size: 1rem;
            }
             #theme-switcher {
                 top: 10px;
                 right: 10px;
                 padding: 6px 12px;
                 font-size: 0.8em;
             }
             main {
                 padding: 20px 15px;
             }
             #compressor-tool {
                 padding: 20px;
             }
             #compressor-tool h2 {
                 font-size: 1.8rem;
                 margin-bottom: 20px;
             }
             .file-upload-area {
                 padding: 20px 15px;
             }
             .upload-icon {
                 font-size: 2.5rem;
             }
             #compressor-tool input[type="text"],
             #compressor-tool button,
             #compressor-tool #download-link {
                 font-size: 1rem;
                 padding: 10px 15px;
             }
        }
        @media (max-width: 480px) {
            header span {
                font-size: 3.5rem;
            }
            header h1 {
                font-size: 2rem;
            }
            header p {
                font-size: 1rem;
            }
            nav a {
                font-size: 0.9rem;
                margin: 0 8px;
            }
             #theme-switcher {
                 top: 5px;
                 right: 5px;
             }
            main {
                 padding: 15px 10px;
            }
            #compressor-tool {
                 padding: 15px;
            }
             #compressor-tool h2 {
                 font-size: 1.5rem;
             }
             .upload-icon {
                 font-size: 2rem;
             }
             .upload-text {
                 font-size: 0.9rem;
             }
            #compressor-tool #user-feedback {
                 font-size: 0.8rem;
             }
        }

         /* Helper class for RGB colors in JS/CSS */
         .hidden-rgb {
             display: none;
         }
         /* Define RGB variables based on hex for JS use */
         body:not([data-theme="dark"]) {
              --accent-color-rgb: 107, 115, 255; /* #6b73ff */
              --success-color-rgb: 72, 187, 120; /* #48bb78 */
              --error-color-rgb: 245, 101, 101; /* #f56565 */
              --warning-color-rgb: 237, 137, 54; /* #ed8936 */
         }
         [data-theme="dark"] {
             --accent-color-rgb: 66, 153, 225; /* #4299e1 */
             --success-color-rgb: 104, 211, 145; /* #68d391 */
             --error-color-rgb: 252, 129, 129; /* #fc8181 */
             --warning-color-rgb: 246, 173, 85; /* #f6ad55 */
         }


        </style>
</head>
<body data-theme="light">

    <header>
        <span>✨</span> <!-- Modernized icon -->
        <h1>Image Compressor</h1>
        <p>Effortlessly shrink your images while keeping the quality you need.</p>
        <button id="theme-switcher">Switch to Dark Theme</button>
    </header>
    <nav>
        <a href="index.html">Home</a>
        <a href="#compressor-tool">Image Tools</a> <!-- Link directly to the tool section -->
        <!-- Assuming PDF tools link would point to another section or page -->
        <!-- <a href="#pdf-tools">PDF Tools</a> -->
    </nav>
    <main>
        <div id="compressor-tool">
            <h2>Compress an Image</h2>
            <form id="compress-form">
                 <!-- Custom styled file input -->
                <label for="image-input" class="file-upload-area">
                    <span class="upload-icon">🖼️</span> <!-- Icon -->
                    <p class="upload-text">Drag & Drop your image here, or <strong>Click to Select File</strong></p>
                    <!-- The actual file input is hidden -->
                    <input type="file" id="image-input" accept="image/*" required>
                </label>

                <label for="compression-level">Target Size (e.g., 100KB, 1MB):</label> <!-- Clearer label -->
                <input type="text" id="compression-level" placeholder="e.g., 100KB, 1MB" required>

                <button type="submit">Compress Image</button>
            </form>

            <div id="output">
                <h3>Compressed Image Preview:</h3>
                <img id="compressed-image" src="" alt="Compressed Image Preview">
                <a id="download-link" href="#" download style="display: none;">Download Compressed Image</a> <!-- Initially hidden -->
                 <div id="result-info" style="margin-top: 15px; font-size: 0.95rem; color: var(--text-color);"></div> <!-- Placeholder for result info -->
            </div>

            <div id="user-feedback"></div>
        </div>
    </main>

    <footer>
        <p>© 2023 Image & PDF Tools. All rights reserved. Crafted with ❤️</p> <!-- Little touch -->
    </footer>

    <script>
         // Helper function to convert hex to RGB for CSS variables
         function hexToRgb(hex) {
             const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
             return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
         }

        // Set default theme on load and update RGB variables
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeSwitcher = document.getElementById('theme-switcher');
            themeSwitcher.textContent = `Switch to ${savedTheme === 'dark' ? 'Light' : 'Dark'} Theme`;

            // Update RGB variables on load
             updateRgbVariables();
        });

        const themeSwitcher = document.getElementById('theme-switcher');
        themeSwitcher.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme); // Save theme preference
            themeSwitcher.textContent = `Switch to ${newTheme === 'dark' ? 'Light' : 'Dark'} Theme`;

            // Update RGB variables on theme switch
            updateRgbVariables();
        });

        // Function to update CSS RGB variables from hex variables
        function updateRgbVariables() {
            const root = document.documentElement;
            const accentHex = getComputedStyle(root).getPropertyValue('--accent-color').trim();
            const successHex = getComputedStyle(root).getPropertyValue('--success-color').trim();
            const errorHex = getComputedStyle(root).getPropertyValue('--error-color').trim();
            const warningHex = getComputedStyle(root).getPropertyValue('--warning-color').trim();

            root.style.setProperty('--accent-color-rgb', hexToRgb(accentHex));
            root.style.setProperty('--success-color-rgb', hexToRgb(successHex));
            root.style.setProperty('--error-color-rgb', hexToRgb(errorHex));
            root.style.setProperty('--warning-color-rgb', hexToRgb(warningHex));
        }


        const fileInput = document.getElementById('image-input');
        const fileUploadArea = document.querySelector('.file-upload-area');
        const uploadText = fileUploadArea.querySelector('.upload-text');
        const originalUploadText = uploadText.innerHTML; // Store original text

        // Handle file selection via custom area click
        fileUploadArea.addEventListener('click', () => {
             fileInput.click(); // Trigger the hidden file input click
        });

        // Handle file selection when a file is chosen
        fileInput.addEventListener('change', (event) => {
             const file = event.target.files[0];
             if (file) {
                 uploadText.innerHTML = `Selected: <strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)`;
                 // Optional: Add a visual indicator to the area
                 fileUploadArea.style.borderColor = 'var(--success-color)';
             } else {
                 uploadText.innerHTML = originalUploadText;
                 fileUploadArea.style.borderColor = 'var(--border-color)';
             }
              // Clear previous output and feedback
              document.getElementById('output').style.display = 'none';
              document.getElementById('user-feedback').textContent = '';
              document.getElementById('user-feedback').className = ''; // Remove classes
              document.getElementById('result-info').textContent = '';
              document.getElementById('compressed-image').src = '';
              document.getElementById('download-link').style.display = 'none';
        });

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false); // Also prevent on body
        });

        // Highlight drop area when dragging over
        ['dragenter', 'dragover'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, () => {
                 fileUploadArea.style.borderColor = 'var(--accent-color)';
                 fileUploadArea.style.backgroundColor = 'rgba(var(--accent-color-rgb, 107, 115, 255), 0.1)';
            }, false);
        });

        // Remove highlight when drag leaves
        ['dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, () => {
                // Only reset color if no file is currently selected
                 if (fileInput.files.length === 0) {
                     fileUploadArea.style.borderColor = 'var(--border-color)';
                     fileUploadArea.style.backgroundColor = 'rgba(var(--accent-color-rgb, 107, 115, 255), 0.05)';
                 } else {
                      // Keep success color if a file is selected
                      fileUploadArea.style.borderColor = 'var(--success-color)';
                      fileUploadArea.style.backgroundColor = 'rgba(var(--accent-color-rgb, 107, 115, 255), 0.05)'; // Or keep light background
                 }

            }, false);
        });

        // Handle drop event
        fileUploadArea.addEventListener('drop', (event) => {
            const dt = event.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                 // Assign files to the hidden input
                 fileInput.files = files;
                 // Manually trigger the change event
                 const changeEvent = new Event('change', { bubbles: true });
                 fileInput.dispatchEvent(changeEvent);
            }
        }, false);

        function preventDefaults(event) {
            event.preventDefault();
            event.stopPropagation();
        }


        document.getElementById('compress-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const compressionLevelInput = document.getElementById('compression-level').value.trim();
            const outputImage = document.getElementById('compressed-image');
            const downloadLink = document.getElementById('download-link');
            const outputSection = document.getElementById('output');
            const userFeedback = document.getElementById('user-feedback');
            const resultInfo = document.getElementById('result-info');
            const compressButton = this.querySelector('button[type="submit"]');

            outputSection.style.display = 'none';
            downloadLink.style.display = 'none'; // Hide download link initially
            resultInfo.textContent = ''; // Clear result info
            userFeedback.textContent = 'Processing...';
            userFeedback.className = 'loading'; // Add loading class
            compressButton.disabled = true; // Disable button

            let targetSizeKB;
            try {
                let value = parseFloat(compressionLevelInput);
                if (compressionLevelInput.toLowerCase().includes('mb')) {
                    targetSizeKB = value * 1024;
                } else if (compressionLevelInput.toLowerCase().includes('kb')) {
                    targetSizeKB = value;
                } else {
                     // If no unit, assume KB for simplicity, but add a warning
                     targetSizeKB = value;
                     if (!isNaN(targetSizeKB) && targetSizeKB > 0) {
                         userFeedback.textContent += ' (Assuming KB as unit)';
                         userFeedback.className = 'warning'; // Indicate assumption
                     }
                }
                if (isNaN(targetSizeKB) || targetSizeKB <= 0) throw new Error("Invalid size");

            } catch (e) {
                userFeedback.textContent = 'Invalid target size. Please enter a positive number followed by KB or MB (e.g., 100KB, 1MB).';
                userFeedback.className = 'error';
                compressButton.disabled = false;
                return;
            }

            if (fileInput.files.length === 0) {
                userFeedback.textContent = 'Please select an image first.';
                userFeedback.className = 'error';
                compressButton.disabled = false;
                return;
            }
            const file = fileInput.files[0];

            try {
                 const img = await loadImage(file);
                 const canvas = createCanvas(img);
                 const ctx = canvas.getContext('2d');
                 ctx.drawImage(img, 0, 0);

                 const originalSizeKB = file.size / 1024;

                 // Check if image is already smaller than target size
                 if (originalSizeKB <= targetSizeKB) {
                    const originalImageUrl = URL.createObjectURL(file);
                    outputImage.src = originalImageUrl;
                    downloadLink.href = originalImageUrl;
                    downloadLink.download = `compressed_${file.name}`;
                    downloadLink.style.display = 'inline-block'; // Show download link
                    outputSection.style.display = 'block';
                    resultInfo.textContent = `Original size: ${originalSizeKB.toFixed(2)}KB`;
                    userFeedback.textContent = `Image is already smaller than or equal to your target size (${targetSizeKB.toFixed(2)}KB). No compression needed.`;
                    userFeedback.className = 'success';
                    return;
                 }

                 // Binary search for quality
                 let low = 0.05;
                 let high = 1.0;
                 let best_blob = null;
                 let attempts = 15; // Increased attempts for better accuracy

                let finalSizeKB = originalSizeKB; // Default to original size

                 while(attempts > 0) {
                    let quality = (low + high) / 2;
                    let blob = await compressImage(canvas, quality);
                    let sizeKB = blob.size / 1024;

                    if (sizeKB <= targetSizeKB) {
                        best_blob = blob; // Found a blob within or below target
                        finalSizeKB = sizeKB; // Update final size
                        low = quality; // Try higher quality to get closer to target
                    } else {
                        high = quality; // Too large, reduce quality
                    }
                    attempts--;
                 }

                 // After binary search, use the best blob found, or the lowest quality if target was too low
                 if (!best_blob) {
                      // If no blob was found <= target (meaning even min quality is > target)
                      let minQualityBlob = await compressImage(canvas, 0.05);
                      best_blob = minQualityBlob;
                      finalSizeKB = minQualityBlob.size / 1024;
                      userFeedback.textContent = `Could not compress image to target size (${targetSizeKB.toFixed(2)}KB). Compressed to the smallest possible size: ${finalSizeKB.toFixed(2)}KB.`;
                      userFeedback.className = 'warning';

                 } else {
                     // Found a blob <= target (the last 'best_blob' from the loop)
                     userFeedback.textContent = `Compression successful! Final size: ${finalSizeKB.toFixed(2)}KB (Target: ${targetSizeKB.toFixed(2)}KB).`;
                     userFeedback.className = 'success';
                 }


                const compressedImageUrl = URL.createObjectURL(best_blob);
                outputImage.src = compressedImageUrl;
                downloadLink.href = compressedImageUrl;
                downloadLink.download = `compressed_${file.name}`;
                downloadLink.style.display = 'inline-block'; // Show download link

                resultInfo.textContent = `Original size: ${originalSizeKB.toFixed(2)}KB | Compressed size: ${finalSizeKB.toFixed(2)}KB`;
                outputSection.style.display = 'block';


            } catch (error) {
                console.error('Compression error:', error);
                userFeedback.textContent = 'An error occurred during compression. Please try again.';
                userFeedback.className = 'error';
            } finally {
                 // Re-enable button after processing, regardless of outcome
                 compressButton.disabled = false;
            }

        });

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onerror = () => {
                         reject(new Error('Failed to load image.'));
                    };
                    img.onload = () => resolve(img);
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                     reject(new Error('Failed to read file.'));
                };
                reader.readAsDataURL(file);
            });
        }

        function createCanvas(img) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            return canvas;
        }

        function compressImage(canvas, quality) {
            return new Promise((resolve, reject) => {
                 if (canvas.toBlob) {
                    canvas.toBlob((blob) => {
                         if (blob) {
                            resolve(blob);
                         } else {
                             // Handle cases where toBlob might fail silently
                             reject(new Error('Canvas toBlob returned null or failed. Check image format/size.'));
                         }
                    }, 'image/jpeg', quality); // Always output JPEG for compression
                 } else {
                     reject(new Error('Browser does not support canvas.toBlob'));
                 }
            });
        }

         // Added event listeners for nav links to prevent default hash behavior and potentially scroll
         document.querySelectorAll('nav a').forEach(anchor => {
             anchor.addEventListener('click', function(e) {
                 // Check if the link is for the home page
                 if (this.getAttribute('href') === 'index.html') {
                     return; // Let the link navigate naturally
                 }
                 // For other links (like #compressor-tool, #pdf-tools), prevent default and scroll if needed
                 e.preventDefault();
                 const targetId = this.getAttribute('href').substring(1);
                 const targetElement = document.getElementById(targetId);
                 if (targetElement) {
                     targetElement.scrollIntoView({ behavior: 'smooth' });
                 } else {
                     // Optionally navigate to index.html with hash if on compressor page
                     // window.location.href = 'index.html' + this.getAttribute('href');
                     // Or do nothing if element not found on this page
                 }
             });
         });

    </script>
</body>
  </html>
